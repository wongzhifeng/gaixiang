# Zeabur 部署配置 - 街巷社区互助平台

# 构建配置
build:
  # 使用 Node.js 构建环境
  builder: nixpacks

  # 构建命令
  buildCommand: |
    # 安装所有依赖（包含 devDependencies）
    npm ci || npm install
    npx prisma generate
    # 确保数据目录存在
    mkdir -p ./data
    # 初始化数据库表结构
    npx prisma db push --force-reset
    npm run build

  # 启动命令
  startCommand: npm start

# 环境变量配置
env:
  # 数据库配置（使用 SQLite 持久化存储）
  DATABASE_URL: "file:./data/data.db"

  # JWT认证配置
  JWT_SECRET: ${{ secrets.JWT_SECRET }}

  # Next.js 配置
  NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
  NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}

  # 应用配置
  NODE_ENV: production
  # 确保安装 devDependencies（双保险：已将Tailwind相关移至dependencies）
  NPM_CONFIG_PRODUCTION: false
  NIXPACKS_NODE_VERSION: 18
  # 指定 Node.js 版本与本地一致
  NODE_VERSION: 18

# 资源分配
resources:
  cpu: 0.5
  memory: 512Mi

# 健康检查
healthCheck:
  path: /
  port: 3000
  initialDelay: 30
  period: 10

# 端口配置
ports:
  - port: 3000
    protocol: HTTP